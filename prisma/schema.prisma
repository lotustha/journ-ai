generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// =========================================
// 1. ENUMS
// =========================================

enum Role {
  ADMIN
  MANAGER
  STAFF
  CLIENT
}

enum TourStatus {
  DRAFT
  DESIGNED
  AGENCY_REVIEW
  PAYMENT_PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
}

enum PaymentType {
  ADVANCE
  BALANCE
}

enum PaymentStatus {
  PENDING
  VERIFYING
  COMPLETED
  FAILED
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// =========================================
// 2. USER & AUTH
// =========================================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  role          Role      @default(CLIENT)
  
  // OPTIONAL: Password is optional so you can add clients manually without them needing to login immediately
  passwordHash  String?   
  
  // OPTIONAL: Profile Picture
  image         String?   

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  clientProfile ClientProfile?
  notifications Notification[]
  createdTours  Tour[]         @relation("TourCreator")
  bookedTours   Tour[]         @relation("TourClient")
}

model ClientProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Contact (Optional)
  phone       String?
  nationality String? 
  address     String? @db.Text

  // Travel Docs (All Optional)
  dateOfBirth    DateTime?
  gender         String?
  passportNumber String?
  passportExpiry DateTime?

  // Preferences & Health (All Optional)
  dietaryInfo String?   // e.g. "Vegetarian"
  medicalInfo String?   @db.Text 
  
  // Safety / Emergency (All Optional)
  emergencyContactName  String?
  emergencyContactPhone String?

  notes String? @db.Text 
  documents ClientDocument[]
}
model ClientDocument {
  id              String        @id @default(cuid())
  name            String        // e.g. "John Passport"
  type            String        // "PASSPORT", "VISA", "TICKET", "INSURANCE", "OTHER"
  url             String        @db.Text
  
  clientProfileId String
  clientProfile   ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  createdAt       DateTime      @default(now())
}
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

// =========================================
// 3. CORE TOUR MANAGEMENT
// =========================================

model Tour {
  id     String     @id @default(cuid())
  name   String
  status TourStatus @default(DRAFT)

  // Logistics
  startLocation String
  destination   String
  startDate     DateTime
  endDate       DateTime
  duration      Int

  // Ownership
  creatorId String?
  creator   User?   @relation("TourCreator", fields: [creatorId], references: [id])

  clientId String?
  client   User?   @relation("TourClient", fields: [clientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  financials         TourFinancials?
  participantSummary ParticipantSummary?
  itinerary          ItineraryDay[]
  payments           PaymentTransaction[]
  incidents          IncidentLog[]
}

model TourFinancials {
  id     String @id @default(cuid())
  tourId String @unique
  tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)

  budget         Decimal @default(0.00) @db.Decimal(10, 2)
  profitMargin   Decimal @default(0.00) @db.Decimal(5, 2)
  sellingPrice   Decimal @default(0.00) @db.Decimal(10, 2)
  totalCollected Decimal @default(0.00) @db.Decimal(10, 2)
}

model ParticipantSummary {
  id     String @id @default(cuid())
  tourId String @unique
  tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)

  totalPax Int @default(0)
  boys     Int @default(0)
  girls    Int @default(0)
  veg      Int @default(0)
  nonVeg   Int @default(0)
}

model PaymentTransaction {
  id     String @id @default(cuid())
  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id])

  amount Decimal       @db.Decimal(10, 2)
  type   PaymentType
  status PaymentStatus @default(PENDING)

  provider String? // e.g. "ESEWA", "BANK_TRANSFER"
  txId     String?
  proofUrl String?

  createdAt DateTime @default(now())
}

// =========================================
// 4. RESOURCE LIBRARY (LOCATIONS & ASSETS)
// =========================================

// --- COUNTRY ---
model Country {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?        @db.Text
  imageUrl    String?        @db.Text // Main Cover Image
  images      CountryImage[] // Gallery
  locations   Location[]
}

model CountryImage {
  id        String  @id @default(cuid())
  url       String  @db.Text
  countryId String
  country   Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
}

// --- LOCATION ---
model Location {
  id        String  @id @default(cuid())
  name      String  @unique // Unique identifier
  countryId String
  country   Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  description String? @db.Text
  altitude    Int? // e.g. 1400 (meters)

  type String @default("DESTINATION") // "DESTINATION" or "STOPOVER"

  imageUrl String?         @db.Text
  images   LocationImage[] // Gallery relation

  hotels      Hotel[]
  activities  Activity[]
  restaurants Restaurant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LocationImage {
  id         String   @id @default(cuid())
  url        String   @db.Text
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
}

// --- HOTEL ---
model Hotel {
  id   String @id @default(cuid())
  name String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  contactInfo String?
  imageUrl    String?      @db.Text
  images      HotelImage[]

  rates         HotelRoomRate[]
  itineraryDays ItineraryDay[]

  createdAt DateTime @default(now())
}

model HotelImage {
  id      String @id @default(cuid())
  url     String @db.Text
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)
}

model HotelRoomRate {
  id      String @id @default(cuid())
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  roomType   String // "Standard", "Deluxe"
  mealPlan   String // "EP", "BB", "MAP"
  inclusions String? @db.Text

  // PRICING (Profit Margin Model)
  costPrice  Decimal @default(0.00) @db.Decimal(10, 2) // Net Rate (Pay to Vendor)
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2) // Gross Rate (Charge to Client)
  currency   String  @default("NPR")
}

// --- VEHICLE ---
model Vehicle {
  id            String  @id @default(cuid())
  name          String // "Toyota Scorpio"
  type          String // "SUV", "Bus"
  plateNumber   String?
  driverName    String?
  contactNumber String?

  imageUrl String?        @db.Text
  images   VehicleImage[]
  details  String?        @db.Text

  // PRICING (Profit Margin Model)
  // 1. Daily Rates
  costPerDay  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPerDay Decimal @default(0.00) @db.Decimal(10, 2)

  // 2. Kilometer Rates
  costPerKm  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPerKm Decimal @default(0.00) @db.Decimal(10, 2)

  // 3. Driver Allowance (Usually pass-through cost)
  driverAllowance Decimal @default(0.00) @db.Decimal(10, 2)

  currency String @default("NPR")

  itineraryDays ItineraryDay[]
}

model VehicleImage {
  id        String  @id @default(cuid())
  url       String  @db.Text
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

// --- ACTIVITY ---
model Activity {
  id   String @id @default(cuid())
  name String

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  details  String?         @db.Text
  imageUrl String?         @db.Text
  images   ActivityImage[]

  // PRICING (Profit Margin Model)
  costPrice  Decimal @default(0.00) @db.Decimal(10, 2) // Net Rate
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2) // Gross Rate
  currency   String  @default("NPR")

  itineraryDays ItineraryDay[]
}

model ActivityImage {
  id         String   @id @default(cuid())
  url        String   @db.Text
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
}

// --- STAFF & GUIDES ---
model Staff {
  id          String  @id @default(cuid())
  name        String
  role        String // e.g. "Senior Guide", "Driver"
  languages   String?
  contactInfo String?

  // PRICING
  dailySalary Decimal @default(0.00) @db.Decimal(10, 2)
  currency    String  @default("NPR")

  details  String?      @db.Text
  imageUrl String?      @db.Text
  images   StaffImage[]
}

model StaffImage {
  id      String @id @default(cuid())
  url     String @db.Text
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
}

// --- RESTAURANTS ---
model Restaurant {
  id   String @id @default(cuid())
  name String

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  cuisine     String? // e.g. "Thakali, Continental"
  contactInfo String?

  // PRICING (Profit Margin Model)
  costPrice  Decimal @default(0.00) @db.Decimal(10, 2) // Net Meal Cost
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2) // Gross Meal Price
  currency   String  @default("NPR")

  details  String?           @db.Text
  imageUrl String?           @db.Text
  images   RestaurantImage[]
}

model RestaurantImage {
  id           String     @id @default(cuid())
  url          String     @db.Text
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
}

// =========================================
// 5. ITINERARY LINKING
// =========================================

model ItineraryDay {
  id        String @id @default(cuid())
  tourId    String
  tour      Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)
  dayNumber Int

  // Resource Links
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id])

  activityId String?
  activity   Activity? @relation(fields: [activityId], references: [id])

  transportId String?
  vehicle     Vehicle? @relation(fields: [transportId], references: [id])

  notes String? @db.Text
}

// =========================================
// 6. OPERATIONS & SAFETY
// =========================================

model IncidentLog {
  id     String @id @default(cuid())
  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id])

  title       String
  description String           @db.Text
  severity    IncidentSeverity @default(LOW)
  reportedAt  DateTime         @default(now())
  resolved    Boolean          @default(false)
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  message   String
  type      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}
