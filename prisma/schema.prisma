generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// =========================================
// 1. ENUMS
// =========================================

enum Role {
  ADMIN
  MANAGER
  STAFF
  CLIENT
}

enum TourStatus {
  DRAFT
  DESIGNED
  AGENCY_REVIEW
  PAYMENT_PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
}

enum PaymentType {
  ADVANCE
  BALANCE
}

enum PaymentStatus {
  PENDING
  VERIFYING
  COMPLETED
  FAILED
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ðŸ†• NEW: Defines what kind of event is happening in the itinerary
enum ItemType {
  TRANSFER // Vehicles, Flights, Trains
  ACCOMMODATION // Hotels, Lodges
  ACTIVITY // Sightseeing, Adventure
  MEAL // Restaurants, Lunch Stops
  NOTE // "Free time", "Border crossing", "Briefing"
}

// =========================================
// 2. USER & AUTH
// =========================================
model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  role  Role    @default(CLIENT)

  passwordHash String?
  image        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clientProfile ClientProfile?
  notifications Notification[]
  createdTours  Tour[]         @relation("TourCreator")
  bookedTours   Tour[]         @relation("TourClient")
}

model ClientProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Contact
  phone       String?
  nationality String?
  address     String? @db.Text

  // Travel Docs
  dateOfBirth    DateTime?
  gender         String?
  passportNumber String?
  passportExpiry DateTime?

  // Preferences & Health
  dietaryInfo String? // e.g. "Vegetarian"
  medicalInfo String? @db.Text

  // Safety / Emergency
  emergencyContactName  String?
  emergencyContactPhone String?

  notes     String?          @db.Text
  documents ClientDocument[]
}

model ClientDocument {
  id   String @id @default(cuid())
  name String // e.g. "John Passport"
  type String // "PASSPORT", "VISA", "TICKET"
  url  String @db.Text

  clientProfileId String
  clientProfile   ClientProfile @relation(fields: [clientProfileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

// =========================================
// 3. CORE TOUR MANAGEMENT
// =========================================

model Tour {
  id     String     @id @default(cuid())
  name   String
  status TourStatus @default(DRAFT)

  // Logistics
  startLocation String
  destination   String
  startDate     DateTime
  endDate       DateTime
  duration      Int

  // Ownership
  creatorId String?
  creator   User?   @relation("TourCreator", fields: [creatorId], references: [id])

  clientId String?
  client   User?   @relation("TourClient", fields: [clientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  financials         TourFinancials?
  participantSummary ParticipantSummary?
  itinerary          ItineraryDay[]
  payments           PaymentTransaction[]
  incidents          IncidentLog[]
}

model TourFinancials {
  id     String @id @default(cuid())
  tourId String @unique
  tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)

  budget         Decimal @default(0.00) @db.Decimal(10, 2)
  profitMargin   Decimal @default(0.00) @db.Decimal(5, 2)
  sellingPrice   Decimal @default(0.00) @db.Decimal(10, 2)
  totalCollected Decimal @default(0.00) @db.Decimal(10, 2)
}

model ParticipantSummary {
  id     String @id @default(cuid())
  tourId String @unique
  tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)

  totalPax Int  @default(0)
  boys     Int?
  girls    Int?
  veg      Int  @default(0)
  nonVeg   Int  @default(0)
}

model PaymentTransaction {
  id     String @id @default(cuid())
  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id])

  amount Decimal       @db.Decimal(10, 2)
  type   PaymentType
  status PaymentStatus @default(PENDING)

  provider String? // e.g. "ESEWA", "BANK_TRANSFER"
  txId     String?
  proofUrl String?

  createdAt DateTime @default(now())
}

// =========================================
// 4. RESOURCE LIBRARY
// =========================================

// --- COUNTRY ---
model Country {
  id          String         @id @default(cuid())
  name        String         @unique
  description String?        @db.Text
  imageUrl    String?        @db.Text
  images      CountryImage[]
  locations   Location[]
}

model CountryImage {
  id        String  @id @default(cuid())
  url       String  @db.Text
  countryId String
  country   Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
}

// --- LOCATION ---
model Location {
  id        String  @id @default(cuid())
  name      String  @unique
  countryId String
  country   Country @relation(fields: [countryId], references: [id], onDelete: Cascade)

  description String? @db.Text
  altitude    Int?
  type        String  @default("DESTINATION") // "DESTINATION" or "STOPOVER"

  imageUrl String?         @db.Text
  images   LocationImage[]

  hotels      Hotel[]
  activities  Activity[]
  restaurants Restaurant[]

  // ðŸ†• NEW: Relations for Smart Routing
  routesStarting Route[]         @relation("RouteOrigin")
  routesEnding   Route[]         @relation("RouteDestination")
  stopovers      RouteStopover[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model LocationImage {
  id         String   @id @default(cuid())
  url        String   @db.Text
  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
}

// --- HOTEL ---
model Hotel {
  id   String @id @default(cuid())
  name String

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  contactInfo String?
  imageUrl    String?      @db.Text
  images      HotelImage[]

  rates HotelRoomRate[]

  // ðŸ†• UPDATED: Linked to Items, not Days
  itineraryItems ItineraryItem[]

  createdAt DateTime @default(now())
}

model HotelImage {
  id      String @id @default(cuid())
  url     String @db.Text
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)
}

model HotelRoomRate {
  id      String @id @default(cuid())
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  roomType   String
  mealPlan   String
  inclusions String? @db.Text

  costPrice  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2)
  currency   String  @default("NPR")
}

// --- VEHICLE ---
model Vehicle {
  id            String  @id @default(cuid())
  name          String
  type          String
  plateNumber   String?
  driverName    String?
  contactNumber String?

  imageUrl String?        @db.Text
  images   VehicleImage[]
  details  String?        @db.Text

  costPerDay  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPerDay Decimal @default(0.00) @db.Decimal(10, 2)

  costPerKm  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPerKm Decimal @default(0.00) @db.Decimal(10, 2)

  driverAllowance Decimal @default(0.00) @db.Decimal(10, 2)
  currency        String  @default("NPR")

  // ðŸ†• UPDATED: Linked to Items
  itineraryItems ItineraryItem[]
}

model VehicleImage {
  id        String  @id @default(cuid())
  url       String  @db.Text
  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

// --- ACTIVITY ---
model Activity {
  id   String @id @default(cuid())
  name String

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  details  String?         @db.Text
  imageUrl String?         @db.Text
  images   ActivityImage[]

  costPrice  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2)
  currency   String  @default("NPR")

  // ðŸ†• UPDATED: Linked to Items
  itineraryItems ItineraryItem[]
}

model ActivityImage {
  id         String   @id @default(cuid())
  url        String   @db.Text
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
}

// --- STAFF ---
model Staff {
  id          String  @id @default(cuid())
  name        String
  role        String
  languages   String?
  contactInfo String?

  dailySalary Decimal @default(0.00) @db.Decimal(10, 2)
  currency    String  @default("NPR")

  details  String?      @db.Text
  imageUrl String?      @db.Text
  images   StaffImage[]
}

model StaffImage {
  id      String @id @default(cuid())
  url     String @db.Text
  staffId String
  staff   Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
}

// --- RESTAURANTS ---
model Restaurant {
  id   String @id @default(cuid())
  name String

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  cuisine     String?
  contactInfo String?

  costPrice  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2)
  currency   String  @default("NPR")

  details  String?           @db.Text
  imageUrl String?           @db.Text
  images   RestaurantImage[]

  // ðŸ†• UPDATED: Linked to Items
  itineraryItems ItineraryItem[]
}

model RestaurantImage {
  id           String     @id @default(cuid())
  url          String     @db.Text
  restaurantId String
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
}

// =========================================
// 5. ITINERARY LINKING (REFACTORED)
// =========================================

// ðŸ†•: A container for "Day 1", "Day 2"
model ItineraryDay {
  id     String @id @default(cuid())
  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id], onDelete: Cascade)

  dayNumber Int // 1, 2, 3...
  title     String? // e.g. "Arrival in Kathmandu"
  date      DateTime? // Optional: Specific date for this day

  items ItineraryItem[]

  createdAt DateTime @default(now())
}

// ðŸ†•: Specific events within a day (Breakfast, Drive, Hotel, Activity)
model ItineraryItem {
  id             String       @id @default(cuid())
  itineraryDayId String
  itineraryDay   ItineraryDay @relation(fields: [itineraryDayId], references: [id], onDelete: Cascade)

  order Int      @default(0) // 0=Morning, 1=Noon, etc.
  type  ItemType // TRANSFER, ACCOMMODATION, etc.

  // -- DYNAMIC RESOURCE LINKS --
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id])

  activityId String?
  activity   Activity? @relation(fields: [activityId], references: [id])

  vehicleId String?
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])

  restaurantId String?
  restaurant   Restaurant? @relation(fields: [restaurantId], references: [id])

  // -- CONTENT & PRICING SNAPSHOTS --
  title       String? // Custom title override (e.g. "Lunch at Mugling")
  description String? @db.Text
  time        String? // e.g. "10:00 AM" or "3 Hours"

  // We lock the price here so database updates don't change historic tours
  costPrice  Decimal @default(0.00) @db.Decimal(10, 2)
  salesPrice Decimal @default(0.00) @db.Decimal(10, 2)
}

// =========================================
// 6. INTELLIGENT ROUTING (THE BRAIN)
// =========================================

// ðŸ†•: Defines a known path (e.g. Kathmandu -> Pokhara)
model Route {
  id String @id @default(cuid())

  originId      String
  destinationId String
  origin        Location @relation("RouteOrigin", fields: [originId], references: [id])
  destination   Location @relation("RouteDestination", fields: [destinationId], references: [id])

  distanceKm   Int? // e.g. 200
  durationMins Int? // e.g. 420 (7 hours)
  description  String? @db.Text

  stopovers RouteStopover[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([originId, destinationId])
}

// ðŸ†•: Points of interest along a route (e.g. Mugling)
model RouteStopover {
  id      String @id @default(cuid())
  routeId String
  route   Route  @relation(fields: [routeId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  isLunchStop Boolean @default(false)
  order       Int     @default(0)
}

// =========================================
// 7. OPERATIONS & SAFETY
// =========================================

model IncidentLog {
  id     String @id @default(cuid())
  tourId String
  tour   Tour   @relation(fields: [tourId], references: [id])

  title       String
  description String           @db.Text
  severity    IncidentSeverity @default(LOW)
  reportedAt  DateTime         @default(now())
  resolved    Boolean          @default(false)
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  message   String
  type      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}
